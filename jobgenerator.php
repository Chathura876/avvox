<?php 
require_once "common/database.php";

// $query = "select * from user where usertype='technician'";
// if ($result = $mysqli->query($query)) {
// 	while ($technician = $result->fetch_object()) {
// 	     echo '"'.$technician->id.'",';
// 	     //echo "<br>";
// 	}
// }

// exit();

$technicians = array("3013","3015","3019","3020","3021","3022","3026","3033","3034","3038","3040","3041","3046","3047","3049","3050","3059","3061","3062","3063","3067","3071","3081","3082","3084","3086","3090","3091","3092","3094","3097","3100","3101","3103","3104","3105","3106","3107","3113","3116","3118","3122","3123","3125","3126","3127","3128","3129","3130","3131","3132","3134","3136","3137","3139","3141","3142","3144","3145","3147","3152","3153","3154","3156","3157","3163","3164","3165","3166","3168","3172","3177","3178","3179","3181","3183","3184","3185","3186","3189","3192","3197","3198","3199","3202","3203","3205","3207","3208","3212","3213","3214","3215","3217","3218","3221","3222","3223","3227","3229","3230","3231","3239","3243","3244","3247","3248","3249","3250","3254","3256","3257","3259","3262","3263","3264","3265","3269","3270","3272","3274","3276","3278","3279","3280","3281","3282","3283","3284","3285","3286","3289","3290","3292","3296","3297","3298","3299","3300","3301","3302","3303","3304","3305","3307","3309","3310","3311","3313","3315","3316","3318","3319","3320","3321","3322","3323","3324","3325","3326","3327","3328","3331","3334","3335","3336","3340","3343","3344","3347","3349","3350","3355","3358","3359","3362","3363","3364","3372","3374","3375","3376","3378","3379","3381","3385","3389","3396","3398","3400","3402","3403","3404","3405","3407","3408","3410","3411","3413","3416","3417","3420","3424","3426","3427","3430","3431","3433","3434","3435","3437","3441","3443","3445","3446","3447","3448","3450","3454","3456","3457","3458","3459","3461","3462","3464","3466","3468","3469","3470","3471","3472","3474","3475","3476","3477","3479","3480","3482","3484","3485","3486","3487","3489","3492","3493","3495","3496","3497","3501","3502","3504","3505","3507","3509","3511","3515","3516","3517","3518","3520","3524","3525","3526","3527","3530","3536","3537","3540","3543","3544","3545","3555","3556","3557","3558","3562","3566","3567","3568","3571","3572","3574","3577","3578","3579","3580","3581","3585","3586","3589","3591","3601","3602","3606","3608","3609","3610","3612","3615","3616","3618","3620","3624","3625","3626","3627","3633","3634","3635","3637","3638","3641","3644","3646","3647","3648","3649","3650","3652","3654","3658","3660","3661","3662","3663","3670","3672","3678","3679","3680","3681","3682","3686","3687","3688","3690","3691","3692","3694","3697","3701","3707","3709","3710","3715","3718","3721","3722","3724","3727","3728","3730","3731","3734","3735","3736","3737","3739","3741","3742","3743","3744","3745","3750","3751","3753","3754","3758","3761","3762","3764","3766","3770","3771","3772","3773","3776","3777","3779","3780","3781","3785","3788","3790","3791","3792","3793","3795","3796","3800","3801","3812","3815","3816","3817","3824","3825","3827","3828","3829","3832","3837","3838","3842","3844","3846","3849","3850","3854","3856","3857","3858","3860","3866","3868","3871","3873","3874","3875","3876","3878","3887","3890","3891","3892","3893","3894","3896","3898","3903","3906","3908","3909","3910","3916","3917","3921","3922","3925","3926","3928","3931","3935","3936","3939","3940","3941","3943","3945","3951","3955","3956","3958","3959","3960","3965","3967","3974","3978","3983","3986","3988","3990","3992","3994","3995","3996","3997","4000","4002","4003","4004","4007","4008","4015","4017","4024","4027","4030","4031","4032","4033","4034","4036","4037","4040","4047","4050","4051","4052","4053","4055","4056","4057","4058","4060","4062","4065","4066","4070","4071","4072","4073","4074","4076","4077","4079","4080","4081","4084","4085","4086","4087","4088","4090","4094","4096","4097","4098","4103","4108","4113","4114","4115","4116","4117","4119","4123","4124","4125","4129","4132","4133","4136","4137","4139","4140","4143","4144","4146","4150","4155","4156","4157","4159","4162","4163","4164","4165","4166","4170","4172","4173","4174","4176","4179","4180","4183","4184","4185","4187","4189","4191","4192","4193","4195","4197","4198","4200","4204","4205","4206","4211","4212","4216","4219","4223","4224","4225","4227","4228","4229","4233","4236","4237","4238","4239","4241","4244","4245","4246","4247","4248","4250","4253","4258","4259","4262","4263","4267","4268","4270","4272","4274","4281","4283","4285","4287","4289","4292","4293","4296","4300","4310","4313","4314","4316","4317","4318","4320","4322","4323","4325","4326","4327","4328","4334","4335","4337","4339","4341","4343","4349","4352","4360","4365","4366","4369","4371","4373","4375","4379","4380","4381","4382","4386","4387","4391","4392","4395","4396","4398","4400","4401","4402","4403","4404","4405","4409","4412","4415","4418","4421","4426","4430","4433","4435","4436","4437","4439","4442","4443","4445","4446","4447","4448","4458","4460","4465","4466","4467","4471","4475","4478","4480","4481","4482","4486","4490","4495","4496","4505","4506","4507","4508","4509","4512","4513","4523"

);


$descriptionarray = array(
"Device doesn't turn on",
"Low sound",
"No sound at all",
"Left speaker not working",
"right speaker not working",
"subwoofer not working",
"Unusual noise"
);


$yearago = strtotime("-1 year");

$query = "select * from customer WHERE dealerid=1290";
if ($result = $mysqli->query($query)) {
	while ($customer = $result->fetch_object()) {
	     //echo $customer->Name;
	     //echo "<br>";
		$randomtechnician = $technicians[array_rand($technicians)];
		$randomdescription = $descriptionarray[array_rand($descriptionarray)];

		//if($customer->purdate <)

		if(strtotime($customer->purdate)>$yearago){
			$jobtype = "Free";
			$status = 1;
		}
		else{
			$jobtype = "Paid";
			$status = 0;
		}

		$timeadded = date("Y-m-d H:i:s");

		$mysqli->begin_transaction();


		$query = "INSERT INTO job (warrantyid, contactname, contactno, techid, jobtype, status, timeadded, addedby) VALUES ('{$customer->warrantyid}', '{$customer->fullname}', '{$customer->phone}', $randomtechnician, '$jobtype', $status, '$timeadded', 1)";

		$firstresult = mysqli_query($mysqli, $query);

		//echo "<br>";

		$query2 = "INSERT INTO joblog (jobid, description, timeadded, addedby) VALUES (LAST_INSERT_ID(), '$randomdescription', '$timeadded', 1)";


		$secondresult = mysqli_query($mysqli, $query2);

		//echo "-------------------------------------------------------------<br>";

		if($firstresult && $secondresult){
			$mysqli->commit();
			//echo "Success";
			//header("Location: ../success.php?action=jobcomplete");
			
		}else{
			$mysqli->rollback();
			//echo "Fail";
		}	


	}
}

?>